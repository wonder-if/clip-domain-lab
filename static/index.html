<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CLIP Attention Explorer</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #0f172a;
      --panel: #111827;
      --accent: #38bdf8;
      --muted: #94a3b8;
      --border: #1f2937;
      --text: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #0b1224, #050910 45%), radial-gradient(circle at 80% 10%, #0b1833, #050910 50%);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 28px 24px 12px 24px;
    }
    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.01em;
    }
    .subhead { color: var(--muted); margin-top: 6px; }
    main { padding: 0 24px 48px 24px; max-width: 1200px; margin: 0 auto; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .card {
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
    }
    label { display: block; font-size: 13px; margin-bottom: 6px; color: var(--muted); }
    select, input, button, textarea {
      width: 100%;
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      transition: border-color 0.2s, transform 0.2s;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.15);
    }
    button {
      background: linear-gradient(120deg, #22d3ee, #3b82f6);
      border: none;
      color: #0b1220;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.35);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    textarea { min-height: 76px; resize: vertical; }
    .file-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .file-row:last-child { border-bottom: none; }
    .file-name { font-size: 13px; }
    .muted { color: var(--muted); font-size: 13px; }
    .results {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .result-card {
      background: rgba(11, 18, 32, 0.9);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
    }
    .result-card img {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 6px 4px; font-size: 13px; }
    th { color: var(--muted); font-weight: 600; }
    tr:not(:last-child) td { border-bottom: 1px solid var(--border); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      color: #67e8f9;
      font-weight: 600;
      font-size: 12px;
    }
    .status { margin-top: 8px; font-size: 13px; }
    .inline-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .chip {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(148, 163, 184, 0.15);
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 720px) {
      .file-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>CLIP Attention Explorer</h1>
    <div class="subhead">Select dataset/model, upload images, set a prompt template, and view predictions with attention overlays.</div>
  </header>
  <main>
    <div class="grid">
      <div class="card">
        <label for="dataset">Dataset</label>
        <select id="dataset"></select>
        <div style="height: 10px"></div>
        <label for="domain">Domain</label>
        <select id="domain"></select>
        <div style="height: 10px"></div>
        <label for="model">Model</label>
        <select id="model"></select>
        <div style="height: 10px"></div>
        <label for="modelRoot">Model root path</label>
        <input type="text" id="modelRoot" placeholder="/mnt/.../models" />
        <div style="height: 10px"></div>
        <label for="prompt">Prompt template</label>
        <textarea id="prompt">a photo of a {CLASS}</textarea>
        <div style="height: 10px"></div>
        <div class="inline-grid">
          <div>
            <label for="topk">Top-K</label>
            <input type="number" id="topk" value="5" min="1" max="20" />
          </div>
          <div>
            <label for="files">Images</label>
            <input type="file" id="files" accept="image/*" multiple />
          </div>
        </div>
        <div style="height: 10px"></div>
        <div id="file-table"></div>
        <div style="height: 12px"></div>
        <button id="run">Run inference</button>
        <div class="status" id="status"></div>
      </div>
      <div class="card">
        <div class="pill" id="session-pill">Idle</div>
        <div style="height: 10px"></div>
        <div class="muted" id="session-meta"></div>
        <div style="height: 12px"></div>
        <div class="muted">Target label defaults to the provided true label (per image). If both are empty, the predicted top-1 is used for visualization.</div>
      </div>
    </div>
    <div class="results" id="results"></div>
  </main>
  <script>
    const state = {
      datasets: [],
      labels: [],
      files: [],
    };

    const datasetSelect = document.getElementById("dataset");
    const domainSelect = document.getElementById("domain");
    const modelSelect = document.getElementById("model");
    const modelRootInput = document.getElementById("modelRoot");
    const promptInput = document.getElementById("prompt");
    const topkInput = document.getElementById("topk");
    const filesInput = document.getElementById("files");
    const fileTable = document.getElementById("file-table");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const sessionMeta = document.getElementById("session-meta");
    const sessionPill = document.getElementById("session-pill");

    function setStatus(text, tone = "muted") {
      statusEl.textContent = text;
      statusEl.style.color = tone === "error" ? "#fca5a5" : "#94a3b8";
    }

    function setSession(text) {
      sessionMeta.textContent = text;
    }

    function setPill(text, color) {
      sessionPill.textContent = text;
      sessionPill.style.background = color;
    }

    async function fetchOptions() {
      const res = await fetch("/api/options");
      const data = await res.json();
      state.datasets = data.datasets;

      datasetSelect.innerHTML = "";
      data.datasets.forEach((ds) => {
        const opt = document.createElement("option");
        opt.value = ds.name;
        opt.textContent = `${ds.name} (${ds.num_classes} classes)`;
        datasetSelect.appendChild(opt);
      });

      modelSelect.innerHTML = "";
      data.models.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.display || m.name;
        modelSelect.appendChild(opt);
      });

      modelRootInput.value = data.default_model_root || modelRootInput.value;

      updateDomains();
    }

    function updateDomains() {
      const selected = datasetSelect.value;
      const ds = state.datasets.find((d) => d.name === selected);
      domainSelect.innerHTML = "";
      if (!ds) return;
      ds.domains.forEach((dom) => {
        const opt = document.createElement("option");
        opt.value = dom.name;
        opt.textContent = dom.name;
        domainSelect.appendChild(opt);
      });
      fetchLabels();
    }

    async function fetchLabels() {
      if (!datasetSelect.value || !domainSelect.value) return;
      setStatus("Loading labels...");
      const res = await fetch(`/api/labels?dataset=${encodeURIComponent(datasetSelect.value)}&domain=${encodeURIComponent(domainSelect.value)}`);
      const data = await res.json();
      state.labels = data.labels || [];
      renderFileTable();
      setStatus("");
    }

    function renderFileTable() {
      if (!state.files.length) {
        fileTable.innerHTML = '<div class="muted">No images selected.</div>';
        return;
      }
      const wrapper = document.createElement("div");
      state.files.forEach((f, idx) => {
        const row = document.createElement("div");
        row.className = "file-row";

        const name = document.createElement("div");
        name.className = "file-name";
        name.textContent = f.file.name;

        const truthSelect = createLabelSelect(idx, "trueLabel", "True label", f.trueLabel);
        const targetSelect = createLabelSelect(idx, "targetLabel", "Target label", f.targetLabel);

        row.appendChild(name);
        row.appendChild(truthSelect);
        row.appendChild(targetSelect);
        wrapper.appendChild(row);
      });
      fileTable.innerHTML = "";
      fileTable.appendChild(wrapper);
    }

    function createLabelSelect(fileIndex, key, labelText, currentValue) {
      const container = document.createElement("div");
      const labelEl = document.createElement("div");
      labelEl.className = "muted";
      labelEl.textContent = labelText;
      const select = document.createElement("select");
      const emptyOpt = document.createElement("option");
      emptyOpt.value = "";
      emptyOpt.textContent = "auto";
      select.appendChild(emptyOpt);
      state.labels.forEach((name, idx) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = `${idx}: ${name}`;
        select.appendChild(opt);
      });
      select.value = currentValue || "";
      select.onchange = (e) => {
        state.files[fileIndex][key] = e.target.value;
        if (key === "trueLabel" && !state.files[fileIndex].targetLabel) {
          state.files[fileIndex].targetLabel = e.target.value;
          renderFileTable();
        }
      };
      container.appendChild(labelEl);
      container.appendChild(select);
      return container;
    }

    filesInput.addEventListener("change", (e) => {
      state.files = Array.from(e.target.files || []).map((file) => ({
        file,
        trueLabel: "",
        targetLabel: "",
      }));
      renderFileTable();
    });

    datasetSelect.addEventListener("change", updateDomains);
    domainSelect.addEventListener("change", fetchLabels);

    document.getElementById("run").addEventListener("click", async () => {
      if (!state.files.length) {
        setStatus("Please select at least one image.", "error");
        return;
      }
      setPill("Running...", "rgba(56, 189, 248, 0.2)");
      setStatus("Running inference...");
      resultsEl.innerHTML = "";

      const form = new FormData();
      form.append("dataset_name", datasetSelect.value);
      form.append("domain_name", domainSelect.value);
      form.append("model_name", modelSelect.value);
      if (modelRootInput.value.trim()) {
        form.append("model_root", modelRootInput.value.trim());
      }
      form.append("prompt_template", promptInput.value.trim());
      form.append("top_k", topkInput.value || "5");
      form.append("target_labels", JSON.stringify(state.files.map((f) => f.targetLabel || null)));
      form.append("true_labels", JSON.stringify(state.files.map((f) => f.trueLabel || null)));
      state.files.forEach((f) => form.append("files", f.file));

      try {
        const res = await fetch("/api/predict", { method: "POST", body: form });
        if (!res.ok) {
          const detail = await res.json().catch(() => ({}));
          throw new Error(detail.detail || "Request failed");
        }
        const data = await res.json();
        renderResults(data);
        setStatus("Done.");
        setPill(`Ready Â· ${data.device}`, "rgba(34, 197, 94, 0.25)");
        setSession(`Model: ${data.model} | Dataset: ${data.dataset} / ${data.domain} | Template: ${data.prompt_template}`);
      } catch (err) {
        setStatus(err.message || "Failed to run inference", "error");
        setPill("Error", "rgba(248, 113, 113, 0.3)");
      }
    });

    function renderResults(data) {
      resultsEl.innerHTML = "";
      (data.results || []).forEach((item) => {
        const card = document.createElement("div");
        card.className = "result-card";

        const title = document.createElement("div");
        title.className = "file-name";
        title.textContent = item.filename;
        card.appendChild(title);

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = `Target: ${item.target_label}`;
        card.appendChild(pill);

        if (item.attention_overlay) {
          const img = document.createElement("img");
          img.src = item.attention_overlay;
          img.alt = "attention overlay";
          card.appendChild(img);
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Label</th><th>Logit</th><th>Prob</th></tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        (item.topk || []).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.label}</td><td>${row.logit.toFixed(3)}</td><td>${(row.prob * 100).toFixed(2)}%</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);

        resultsEl.appendChild(card);
      });
    }

    fetchOptions().then(() => setPill("Ready", "rgba(34, 197, 94, 0.25)")).catch(() => setPill("Config error", "rgba(248, 113, 113, 0.3)"));
  </script>
</body>
</html>
